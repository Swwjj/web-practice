<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.webproj.mappers.OrderMapper">

    <!-- =================== 结果映射 =================== -->
    <resultMap id="OrderResultMap" type="com.example.webproj.pojo.Order">
        <id column="id" property="id"/>
        <result column="order_no"  property="orderNo"/>
        <result column="uid"       property="uid"/>
        <result column="addr_id"   property="addrId"/>
        <result column="amount"    property="amount"/>
        <result column="type"      property="type"/>
        <result column="freight"   property="freight"/>
        <result column="status"    property="status"/>
        <result column="payment_time"  property="paymentTime"/>
        <result column="delivery_time" property="deliveryTime"/>
        <result column="finish_time"   property="finishTime"/>
        <result column="close_time"    property="closeTime"/>
        <result column="created"       property="created"/>

        <!-- 关联收货地址 -->
        <association property="address" javaType="com.example.webproj.pojo.Address">
            <id column="a_id"            property="id"/>
            <result column="a_name"      property="name"/>
            <result column="a_phone"     property="phone"/>
            <result column="a_mobile"    property="mobile"/>
            <result column="a_province"  property="province"/>
            <result column="a_city"      property="city"/>
            <result column="a_district"  property="district"/>
            <result column="a_addr"      property="addr"/>
            <result column="a_zip"       property="zip"/>
        </association>

        <!-- 订单明细列表 -->
        <collection property="orderItems" ofType="com.example.webproj.pojo.OrderItem">
            <id column="oi_id"              property="id"/>
            <result column="oi_goods_id"    property="goodsId"/>
            <result column="oi_goods_name"  property="goodsName"/>
            <result column="oi_icon_url"    property="iconUrl"/>
            <result column="oi_price"       property="price"/>
            <result column="oi_quantity"    property="quantity"/>
            <result column="oi_total_price" property="totalPrice"/>
            <result column="oi_created"     property="created"/>
        </collection>
    </resultMap>

    <!-- ============ 管理端 ============ -->
<select id="findOrdersNoPages" resultMap="OrderResultMap">
    SELECT
        -- 订单表字段
        o.id AS id,
        o.order_no AS order_no,
        o.uid AS uid,
        o.addr_id AS addr_id,
        o.amount AS amount,
        o.type AS type,
        o.freight AS freight,
        o.status AS status,
        o.payment_time AS payment_time,
        o.delivery_time AS delivery_time,
        o.finish_time AS finish_time,
        o.close_time AS close_time,
        o.created AS created,

        -- 收货地址字段
        a.id AS a_id,
        a.name AS a_name,
        a.phone AS a_phone,
        a.mobile AS a_mobile,
        a.province AS a_province,
        a.city AS a_city,
        a.district AS a_district,
        a.addr AS a_addr,
        a.zip AS a_zip,

        -- 订单明细字段
        oi.id AS oi_id,
        oi.goods_id AS oi_goods_id,
        oi.goods_name AS oi_goods_name,
        oi.icon_url AS oi_icon_url,
        oi.price AS oi_price,
        oi.quantity AS oi_quantity,
        oi.total_price AS oi_total_price,
        oi.created AS oi_created
    FROM
        `order` o
            LEFT JOIN
        address a ON o.addr_id = a.id
            LEFT JOIN
        order_item oi ON o.id = oi.order_id
    <where>
        <if test="orderNo != null">
            o.order_no = #{orderNo}
        </if>
    </where>
</select>

    <select id="findOrdersPaging" resultMap="OrderResultMap">
        SELECT
            -- 订单表字段
            o.id AS id,
            o.order_no AS order_no,
            o.uid AS uid,
            o.addr_id AS addr_id,
            o.amount AS amount,
            o.type AS type,
            o.freight AS freight,
            o.status AS status,
            o.payment_time AS payment_time,
            o.delivery_time AS delivery_time,
            o.finish_time AS finish_time,
            o.close_time AS close_time,
            o.created AS created,

            -- 收货地址字段
            a.id AS a_id,
            a.name AS a_name,
            a.phone AS a_phone,
            a.mobile AS a_mobile,
            a.province AS a_province,
            a.city AS a_city,
            a.district AS a_district,
            a.addr AS a_addr,
            a.zip AS a_zip,

            -- 订单明细字段
            oi.id AS oi_id,
            oi.goods_id AS oi_goods_id,
            oi.goods_name AS oi_goods_name,
            oi.icon_url AS oi_icon_url,
            oi.price AS oi_price,
            oi.quantity AS oi_quantity,
            oi.total_price AS oi_total_price,
            oi.created AS oi_created
        FROM
            `order` o
                LEFT JOIN
            address a ON o.addr_id = a.id
                LEFT JOIN
            order_item oi ON o.id = oi.order_id
        ORDER BY o.id DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="getOrderCount" resultType="int">
        SELECT COUNT(*)
        FROM `order` o
    </select>

    <select id="getDetailByOrderNo" resultMap="OrderResultMap">
        SELECT
        -- 订单表字段
        o.id AS id,
        o.order_no AS order_no,
        o.uid AS uid,
        o.addr_id AS addr_id,
        o.amount AS amount,
        o.type AS type,
        o.freight AS freight,
        o.status AS status,
        o.payment_time AS payment_time,
        o.delivery_time AS delivery_time,
        o.finish_time AS finish_time,
        o.close_time AS close_time,
        o.created AS created,

        -- 收货地址字段
        a.id AS a_id,
        a.name AS a_name,
        a.phone AS a_phone,
        a.mobile AS a_mobile,
        a.province AS a_province,
        a.city AS a_city,
        a.district AS a_district,
        a.addr AS a_addr,
        a.zip AS a_zip,

        -- 订单明细字段
        oi.id AS oi_id,
        oi.goods_id AS oi_goods_id,
        oi.goods_name AS oi_goods_name,
        oi.icon_url AS oi_icon_url,
        oi.price AS oi_price,
        oi.quantity AS oi_quantity,
        oi.total_price AS oi_total_price,
        oi.created AS oi_created
        FROM
        `order` o
        LEFT JOIN
        address a ON o.addr_id = a.id
        LEFT JOIN
        order_item oi ON o.id = oi.order_id
        WHERE
        o.order_no = #{orderNo}
    </select>

    <!-- ============ 用户端 ============ -->
    <update id="updateOrderStatus">
        UPDATE `order`
        SET status = #{status},
            updated = NOW()
        WHERE
            order_no = #{orderNo}
        AND uid = #{uid}
    </update>


    <select id="getOrderCountByUserId" resultType="int">
        SELECT COUNT(*)
        FROM `order` o
        WHERE uid=#{uid}
    </select>

    <select id="findUserOrders" resultMap="OrderResultMap">
        SELECT
            -- 订单表字段
            o.id AS id,
            o.order_no AS order_no,
            o.uid AS uid,
            o.addr_id AS addr_id,
            o.amount AS amount,
            o.type AS type,
            o.freight AS freight,
            o.status AS status,
            o.payment_time AS payment_time,
            o.delivery_time AS delivery_time,
            o.finish_time AS finish_time,
            o.close_time AS close_time,
            o.created AS created,

            -- 收货地址字段
            a.id AS a_id,
            a.name AS a_name,
            a.phone AS a_phone,
            a.mobile AS a_mobile,
            a.province AS a_province,
            a.city AS a_city,
            a.district AS a_district,
            a.addr AS a_addr,
            a.zip AS a_zip,

            -- 订单明细字段
            oi.id AS oi_id,
            oi.goods_id AS oi_goods_id,
            oi.goods_name AS oi_goods_name,
            oi.icon_url AS oi_icon_url,
            oi.price AS oi_price,
            oi.quantity AS oi_quantity,
            oi.total_price AS oi_total_price,
            oi.created AS oi_created
        FROM
            `order` o
                LEFT JOIN
            address a ON o.addr_id = a.id
                LEFT JOIN
            order_item oi ON o.id = oi.order_id

        WHERE o.uid=#{uid}
        AND o.status=#{status}

        ORDER BY o.id DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- ============ 创建订单 ============ -->
    
    <!-- 插入订单主表 -->
    <insert id="insertOrder" parameterType="com.example.webproj.pojo.Order" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `order` (
            order_no,
            uid,
            addr_id,
            amount,
            type,
            freight,
            status,
            created,
            updated
        ) VALUES (
            #{orderNo},
            #{uid},
            #{addrId},
            #{amount},
            #{type},
            #{freight},
            #{status},
            #{created},
            #{updated}
        )
    </insert>

    <!-- 插入订单项 -->
    <insert id="insertOrderItem" parameterType="com.example.webproj.pojo.OrderItem">
        INSERT INTO order_item (
            uid,
            order_id,
            goods_id,
            goods_name,
            icon_url,
            price,
            quantity,
            total_price,
            created,
            updated
        ) VALUES (
            #{uid},
            #{orderId},
            #{goodsId},
            #{goodsName},
            #{iconUrl},
            #{price},
            #{quantity},
            #{totalPrice},
            #{created},
            #{updated}
        )
    </insert>

    <!-- 清空用户购物车 -->
    <delete id="clearUserCart">
        DELETE FROM shopping_cart
        WHERE user_id = #{userId}
    </delete>

    <!-- 扣减商品库存 -->
    <update id="decreaseProductStock">
        UPDATE product
        SET stock = stock - #{quantity},
            updated = NOW()
        WHERE id = #{productId}
        AND stock >= #{quantity}
    </update>

</mapper>